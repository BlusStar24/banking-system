<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Nhập số tài khoản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="container my-5" style="max-width:520px">
        <h2 class="mb-3 text-center">Nhập số tài khoản vào case</h2>

        <div id="meta" class="text-muted small mb-3"></div>

        <form id="accountForm" class="row g-3">
            <div class="col-12">
                <label class="form-label">Số tài khoản</label>
                <input type="text" id="accountNumber" class="form-control" placeholder="VD: 9704123456789" required />
                <div class="form-text">Để đúng định dạng số (8–20 chữ số).</div>
            </div>
            <div class="col-12">
                <button type="submit" id="submitBtn" class="btn btn-primary w-100">Gửi</button>
            </div>
        </form>

        <div id="result" class="mt-3"></div>
    </div>

    <script>
        const API_URL = "http://localhost:5053/workflow/account/account-number";
        const params = new URLSearchParams(window.location.search);
        const caseId = params.get("caseId") || "";
        const taskId = params.get("taskId") || "";

        // Hiện thông tin context
        document.getElementById("meta").innerText =
            `Case ID: ${caseId || "(không có)"}  •  Task ID: ${taskId || "(không có)"}`;

        const form = document.getElementById("accountForm");
        const input = document.getElementById("accountNumber");
        const btn = document.getElementById("submitBtn");
        const result = document.getElementById("result");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const acc = (input.value || "").trim();

            if (!acc || !/^\d{8,20}$/.test(acc)) {
                return show("Số tài khoản không hợp lệ (8–20 chữ số).", "danger");
            }
            if (!taskId && !caseId) {
                return show("Thiếu caseId/taskId.", "danger");
            }

            const payload = taskId
                ? { taskId, accountnumber: acc }
                : { caseId, accountnumber: acc };

            try {
                btn.disabled = true;
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

                show(`${data.message} (Task ID: ${data.taskId})`, "success");
                input.value = "";
            } catch (err) {
                show(`Lỗi: ${err.message}`, "danger");
            } finally {
                btn.disabled = false;
            }
        });

        function show(msg, type) {
            result.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        }
    </script>
</body>

</html>