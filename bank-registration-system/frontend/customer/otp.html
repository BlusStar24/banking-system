<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Nhập OTP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="container my-5">
        <h2 class="mb-4">Xác minh OTP</h2>
        <div id="info" class="mb-3"></div>

        <form id="otpForm" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Mã OTP</label>
                <input type="text" name="otp" class="form-control" required />
            </div>
            <div class="col-12">
                <button type="submit" id="verifyBtn" class="btn btn-success">Xác minh OTP</button>
                <button type="button" id="resendBtn" class="btn btn-secondary">Gửi lại OTP</button>
                <button type="button" id="gotoCreateAccount" class="btn btn-primary" disabled>Nhập số tài khoản</button>
            </div>
        </form>

        <div id="result" class="mt-3"></div>
    </div>

    <script>
        const API_BASE = "http://localhost:5053/workflow/account";
        const params = new URLSearchParams(window.location.search);
        const caseId = params.get("caseId");
        const phone = params.get("phone");
        const email = params.get("email");

        const $info = document.getElementById("info");
        const $result = document.getElementById("result");
        const $gotoBtn = document.getElementById("gotoCreateAccount");
        const $verify = document.getElementById("verifyBtn");

        $info.innerHTML = `
    <b>Case ID:</b> ${caseId}<br/>
    <b>Số điện thoại:</b> ${phone}<br/>
    <b>Email:</b> ${email}
  `;

        function show(msg, type = "info") {
            $result.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        }

        // ===== Submit OTP =====
        document.getElementById("otpForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const otp = e.target.otp.value.trim();
            if (!otp) return show("Vui lòng nhập OTP", "danger");

            try {
                $verify.disabled = true;

                // 1) verify OTP
                const res = await fetch(`${API_BASE}/otp`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ caseId, phone, email, otp })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                show(data.message, "success");

                // 2) Mở kết nối SSE để theo dõi trạng thái case realtime
                const sseUrl = `${API_BASE}/state/stream?caseId=${encodeURIComponent(caseId)}`;
                const sse = new EventSource(sseUrl);

                // luôn khoá nút khi mới mở SSE
                $gotoBtn.disabled = true;

                sse.onmessage = (e) => {
                    const s = JSON.parse(e.data);
                    if (s.approvalPending) {
                        $gotoBtn.disabled = true;
                        show("Hồ sơ đang chờ Nhân viên phê duyệt. Vui lòng đợi...", "warning");
                        return;
                    }

                    if (s.createAccountReady && s.taskId) {
                        $gotoBtn.disabled = false;
                        $gotoBtn.onclick = () =>
                            window.location.href = `http://localhost:3000/createaccountnumber.html?caseId=${caseId}&taskId=${s.taskId}`;
                        show("Đã sẵn sàng bước 'Tạo số tài khoản'.", "success");
                        // Nếu không cần lắng nghe tiếp có thể đóng SSE:
                        // sse.close();
                    } else {
                        $gotoBtn.disabled = true;
                        show("Đang chờ chuyển sang bước 'Tạo số tài khoản'...", "info");
                    }
                };

                sse.onerror = () => {
                    // EventSource tự reconnect; optional: báo nhẹ
                    // show("Mất kết nối realtime, sẽ tự nối lại...", "secondary");
                };

                window.addEventListener('beforeunload', () => sse.close());
            } catch (err) {
                show(`Lỗi: ${err.message}`, "danger");
            } finally {
                $verify.disabled = false;
            }
        });


        // 3) Gửi lại OTP (nếu bạn có route proxy ở gateway thì đổi sang đó)
        document.getElementById("resendBtn").addEventListener("click", async () => {
            try {
                // TODO: nếu cần, tạo route tại 5053 để proxy thay vì gọi trực tiếp service nội bộ
                const r = await fetch("http://otp-service:8080/api/otp/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phone, email, method: "email" })
                });
                if (!r.ok) throw new Error("Gửi lại OTP thất bại");
                alert("Đã gửi lại OTP thành công!");
            } catch (e) {
                alert("Lỗi: " + e.message);
            }
        });
    </script>

</body>

</html>